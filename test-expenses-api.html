<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ุงุฎุชุจุงุฑ API ุงููุตุฑููุงุช</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .btn { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        .btn:hover { background: #0056b3; }
        #results { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ุงุฎุชุจุงุฑ API ุงููุตุฑููุงุช</h1>
    
    <div class="test-section">
        <h2>ุงููุดููุฉ ุงููุจูุบ ุนููุง:</h2>
        <p class="error">โ 500 Internal Server Error ูู /api/expenses/stats</p>
        <p class="info">โน๏ธ ุงูุณุจุจ: ุงุณุชุฎุฏุงู MySQL syntax ูู SQLite database</p>
        <p class="success">โ ุชู ุฅุตูุงุญ ุงูู SQL query ููููู ูุชูุงูู ูุน SQLite</p>
    </div>
    
    <div class="test-section">
        <h2>ุงุฎุชุจุงุฑ API ุงููุตุฑููุงุช:</h2>
        <button class="btn" onclick="testExpensesStats()">ุงุฎุชุจุงุฑ ุฅุญุตุงุฆูุงุช ุงููุตุฑููุงุช</button>
        <button class="btn" onclick="testExpensesList()">ุงุฎุชุจุงุฑ ูุงุฆูุฉ ุงููุตุฑููุงุช</button>
        <button class="btn" onclick="testCreateExpense()">ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ูุตุฑูู</button>
        <button class="btn" onclick="testDatabaseTables()">ูุญุต ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช</button>
    </div>
    
    <div class="test-section">
        <h2>ุงูุฅุตูุงุญ ุงููุทุจู:</h2>
        <h3>ูุจู ุงูุฅุตูุงุญ (MySQL syntax):</h3>
        <pre>
SELECT 
    DATE_FORMAT(expense_date, '%Y-%m') as month,
    SUM(amount) as total,
    COUNT(*) as count
FROM expenses 
WHERE expense_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
GROUP BY DATE_FORMAT(expense_date, '%Y-%m')
ORDER BY month DESC
        </pre>
        
        <h3>ุจุนุฏ ุงูุฅุตูุงุญ (SQLite syntax):</h3>
        <pre>
SELECT 
    strftime('%Y-%m', expense_date) as month,
    SUM(amount) as total,
    COUNT(*) as count
FROM expenses 
WHERE expense_date >= date('now', '-12 months')
GROUP BY strftime('%Y-%m', expense_date)
ORDER BY month DESC
        </pre>
    </div>
    
    <div class="test-section">
        <h2>ุงููุชุงุฆุฌ:</h2>
        <div id="results">ุงููุฑ ุนูู ุฃู ุฒุฑ ุฃุนูุงู ูุจุฏุก ุงูุงุฎุชุจุงุฑ...</div>
    </div>

    <script>
        const API_BASE = (function () {
            try {
                const origin = window.location.origin;
                if (!origin || origin === 'null') return 'http://localhost:5000/api';
                return origin.replace(/\/$/, '') + '/api';
            } catch (e) {
                return 'http://localhost:5000/api';
            }
        })();
        
        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('results').textContent = '';
        }
        
        async function testExpensesStats() {
            clearLog();
            log('๐งช ุงุฎุชุจุงุฑ ุฅุญุตุงุฆูุงุช ุงููุตุฑููุงุช...');
            log(`API Base: ${API_BASE}`);
            
            try {
                log(`๐ค ุฅุฑุณุงู GET ุฅูู: ${API_BASE}/expenses/stats`);
                
                const response = await fetch(`${API_BASE}/expenses/stats`);
                
                log(`๐ฅ ุงุณุชุฌุงุจุฉ HTTP: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`โ ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ: ${errorText}`);
                    return;
                }
                
                const result = await response.json();
                log(`โ ูุฌุญ ุฌูุจ ุงูุฅุญุตุงุฆูุงุช!`);
                log(`๐ ููุน monthlyTrend: ${typeof result.monthlyTrend}`);
                log(`๐ ูู monthlyTrend array: ${Array.isArray(result.monthlyTrend)}`);
                log(`๐ ูููุฉ monthlyTrend: ${JSON.stringify(result.monthlyTrend)}`);
                log(`๐ ุงูุฅุญุตุงุฆูุงุช ุงููุงููุฉ: ${JSON.stringify(result, null, 2)}`);
                
                // Test the specific issue
                if (Array.isArray(result.monthlyTrend)) {
                    log(`โ monthlyTrend ูู array ุตุญูุญ`);
                    log(`๐ ุนุฏุฏ ุงูุนูุงุตุฑ: ${result.monthlyTrend.length}`);
                } else {
                    log(`โ monthlyTrend ููุณ array! ุงูููุน: ${typeof result.monthlyTrend}`);
                    log(`๐ง ูุฌุจ ุฅุตูุงุญ ูููู ุงูุจูุงูุงุช ูู ุงูู backend`);
                }
                
            } catch (error) {
                log(`โ ุฎุทุฃ ูู ุงูุดุจูุฉ: ${error.message}`);
                log(`๐ ุชูุงุตูู ุงูุฎุทุฃ: ${error.stack}`);
            }
        }
        
        async function testExpensesList() {
            clearLog();
            log('๐งช ุงุฎุชุจุงุฑ ูุงุฆูุฉ ุงููุตุฑููุงุช...');
            
            try {
                log(`๐ค ุฅุฑุณุงู GET ุฅูู: ${API_BASE}/expenses`);
                
                const response = await fetch(`${API_BASE}/expenses`);
                
                log(`๐ฅ ุงุณุชุฌุงุจุฉ HTTP: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`โ ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ: ${errorText}`);
                    return;
                }
                
                const result = await response.json();
                log(`โ ูุฌุญ ุฌูุจ ูุงุฆูุฉ ุงููุตุฑููุงุช!`);
                log(`๐ ุนุฏุฏ ุงููุตุฑููุงุช: ${result.expenses?.length || 0}`);
                log(`๐ ุงูุจูุงูุงุช: ${JSON.stringify(result, null, 2)}`);
                
            } catch (error) {
                log(`โ ุฎุทุฃ ูู ุงูุดุจูุฉ: ${error.message}`);
            }
        }
        
        async function testCreateExpense() {
            clearLog();
            log('๐งช ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ูุตุฑูู...');
            
            const testExpense = {
                expense_date: new Date().toISOString().split('T')[0],
                category: 'ูููุฏ',
                description: 'ูุตุฑูู ุชุฌุฑูุจู - ' + new Date().getTime(),
                amount: 100,
                notes: 'ุงุฎุชุจุงุฑ API'
            };
            
            try {
                log(`๐ค ุฅุฑุณุงู POST ุฅูู: ${API_BASE}/expenses`);
                log(`๐ฆ ุงูุจูุงูุงุช: ${JSON.stringify(testExpense, null, 2)}`);
                
                const response = await fetch(`${API_BASE}/expenses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testExpense)
                });
                
                log(`๐ฅ ุงุณุชุฌุงุจุฉ HTTP: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`โ ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ: ${errorText}`);
                    return;
                }
                
                const result = await response.json();
                log(`โ ูุฌุญ ุฅุถุงูุฉ ุงููุตุฑูู!`);
                log(`๐ ุงููุตุฑูู ุงูุฌุฏูุฏ: ${JSON.stringify(result, null, 2)}`);
                
            } catch (error) {
                log(`โ ุฎุทุฃ ูู ุงูุดุจูุฉ: ${error.message}`);
            }
        }
        
        async function testDatabaseTables() {
            clearLog();
            log('๐งช ูุญุต ุฌุฏุงูู ูุงุนุฏุฉ ุงูุจูุงูุงุช...');
            
            // Test if we can access basic endpoints to verify database connection
            const endpoints = [
                '/clients',
                '/contractors', 
                '/crushers',
                '/expenses'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    log(`๐ค ูุญุต: ${API_BASE}${endpoint}`);
                    
                    const response = await fetch(`${API_BASE}${endpoint}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`โ ${endpoint}: ูุนูู ุจุดูู ุตุญูุญ`);
                    } else {
                        log(`โ ${endpoint}: ุฎุทุฃ ${response.status}`);
                    }
                    
                } catch (error) {
                    log(`โ ${endpoint}: ุฎุทุฃ ูู ุงูุงุชุตุงู - ${error.message}`);
                }
            }
        }
        
        // Test on page load
        window.addEventListener('load', () => {
            log('๐ ุตูุญุฉ ุงุฎุชุจุงุฑ ุงููุตุฑููุงุช ุฌุงูุฒุฉ');
            log(`๐ API Base URL: ${API_BASE}`);
            log('๐ก ุงููุฑ ุนูู ุงูุฃุฒุฑุงุฑ ุฃุนูุงู ูุงุฎุชุจุงุฑ API');
            log('');
            log('๐ง ุงูุฅุตูุงุญ ุงููุทุจู:');
            log('- ุชู ุชุบููุฑ MySQL syntax ุฅูู SQLite syntax');
            log('- DATE_FORMAT โ strftime');
            log('- CURDATE() โ date("now")');
            log('- DATE_SUB โ date("now", "-12 months")');
        });
    </script>
</body>
</html>