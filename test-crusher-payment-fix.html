<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ุงุฎุชุจุงุฑ ุฅุตูุงุญ ุฏูุนุงุช ุงููุณุงุฑุงุช</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .btn { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        .btn:hover { background: #0056b3; }
        #results { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ุงุฎุชุจุงุฑ ุฅุตูุงุญ ุฏูุนุงุช ุงููุณุงุฑุงุช</h1>
    
    <div class="test-section">
        <h2>ุงููุดููุฉ ุงููุจูุบ ุนููุง:</h2>
        <p class="error">โ 500 Internal Server Error ุนูุฏ ุฅุถุงูุฉ ุฏูุนุฉ ูููุณุงุฑุฉ</p>
        <p class="info">โน๏ธ ุงูุณุจุจ: ุชุถุงุฑุจ ูู ุฃุณูุงุก ุงูุฃุนูุฏุฉ - crusher_payments ูุณุชุฎุฏู 'payment_method' ุจุฏูุงู ูู 'method'</p>
        <p class="success">โ ุชู ุฅุตูุงุญ ุงูู backend ููุณุชุฎุฏู 'payment_method' ูููุณุงุฑุงุช</p>
    </div>
    
    <div class="test-section">
        <h2>ููุงุฑูุฉ ุฃุณูุงุก ุงูุฃุนูุฏุฉ:</h2>
        <table border="1" style="border-collapse: collapse; width: 100%;">
            <tr>
                <th>ุงูุฌุฏูู</th>
                <th>ุนููุฏ ุทุฑููุฉ ุงูุฏูุน</th>
                <th>ุงูุญุงูุฉ</th>
            </tr>
            <tr>
                <td>payments (ุนููุงุก)</td>
                <td>method</td>
                <td class="success">โ ูุนูู</td>
            </tr>
            <tr>
                <td>contractor_payments (ููุงูููู)</td>
                <td>method</td>
                <td class="success">โ ูุนูู</td>
            </tr>
            <tr>
                <td>crusher_payments (ูุณุงุฑุงุช)</td>
                <td>payment_method</td>
                <td class="success">โ ุชู ุงูุฅุตูุงุญ</td>
            </tr>
        </table>
    </div>
    
    <div class="test-section">
        <h2>ุงุฎุชุจุงุฑ ุฏูุนุงุช ุงููุณุงุฑุงุช:</h2>
        <button class="btn" onclick="testAddCrusherPayment()">ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุฏูุนุฉ ูุณุงุฑุฉ</button>
        <button class="btn" onclick="testGetCrusherPayments()">ุงุฎุชุจุงุฑ ุฌูุจ ุฏูุนุงุช ุงููุณุงุฑุฉ</button>
        <button class="btn" onclick="testCrusherDetails()">ุงุฎุชุจุงุฑ ุชูุงุตูู ุงููุณุงุฑุฉ</button>
    </div>
    
    <div class="test-section">
        <h2>ุงูุฅุตูุงุญ ุงููุทุจู:</h2>
        <h3>ูุจู ุงูุฅุตูุงุญ:</h3>
        <pre>
const paymentData = {
    crusher_id: crusherId,
    amount: parseFloat(amount),
    method: method || 'ููุฏู',  // โ ุฎุทุฃ - ุงูุฌุฏูู ูุณุชุฎุฏู payment_method
    // ...
};
        </pre>
        
        <h3>ุจุนุฏ ุงูุฅุตูุงุญ:</h3>
        <pre>
const paymentData = {
    crusher_id: crusherId,
    amount: parseFloat(amount),
    payment_method: method || 'ููุฏู',  // โ ุตุญูุญ - ูุทุงุจู schema ุงูุฌุฏูู
    // ...
};
        </pre>
    </div>
    
    <div class="test-section">
        <h2>ุงููุชุงุฆุฌ:</h2>
        <div id="results">ุงููุฑ ุนูู ุฃู ุฒุฑ ุฃุนูุงู ูุจุฏุก ุงูุงุฎุชุจุงุฑ...</div>
    </div>

    <script>
        const API_BASE = (function () {
            try {
                const origin = window.location.origin;
                if (!origin || origin === 'null') return 'http://localhost:5000/api';
                return origin.replace(/\/$/, '') + '/api';
            } catch (e) {
                return 'http://localhost:5000/api';
            }
        })();
        
        function log(message) {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.textContent += `[${timestamp}] ${message}\n`;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('results').textContent = '';
        }
        
        async function testAddCrusherPayment() {
            clearLog();
            log('๐งช ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุฏูุนุฉ ูููุณุงุฑุฉ...');
            log(`API Base: ${API_BASE}`);
            
            const crusherId = 1; // ุงูุชุฑุงุถ ุฃู ุงููุณุงุฑุฉ ุฑูู 1 ููุฌูุฏุฉ
            const testPayment = {
                amount: 500,
                method: 'ููุฏู',
                note: 'ุฏูุนุฉ ุชุฌุฑูุจูุฉ - ' + new Date().getTime(),
                date: new Date().toISOString().split('T')[0]
            };
            
            try {
                log(`๐ค ุฅุฑุณุงู POST ุฅูู: ${API_BASE}/crushers/${crusherId}/payments`);
                log(`๐ฆ ุงูุจูุงูุงุช: ${JSON.stringify(testPayment, null, 2)}`);
                
                const response = await fetch(`${API_BASE}/crushers/${crusherId}/payments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testPayment)
                });
                
                log(`๐ฅ ุงุณุชุฌุงุจุฉ HTTP: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`โ ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ: ${errorText}`);
                    return;
                }
                
                const result = await response.json();
                log(`โ ูุฌุญ ุฅุถุงูุฉ ุงูุฏูุนุฉ!`);
                log(`๐ ุงูุฏูุนุฉ ุงูุฌุฏูุฏุฉ: ${JSON.stringify(result, null, 2)}`);
                
                // Check if payment_method is correctly saved
                if (result.payment_method) {
                    log(`โ payment_method ูุญููุธ ุจุดูู ุตุญูุญ: ${result.payment_method}`);
                } else if (result.method) {
                    log(`โ๏ธ ุชู ุญูุธ method ุจุฏูุงู ูู payment_method: ${result.method}`);
                } else {
                    log(`โ ูู ูุชู ุญูุธ ุทุฑููุฉ ุงูุฏูุน`);
                }
                
            } catch (error) {
                log(`โ ุฎุทุฃ ูู ุงูุดุจูุฉ: ${error.message}`);
                log(`๐ ุชูุงุตูู ุงูุฎุทุฃ: ${error.stack}`);
            }
        }
        
        async function testGetCrusherPayments() {
            clearLog();
            log('๐งช ุงุฎุชุจุงุฑ ุฌูุจ ุฏูุนุงุช ุงููุณุงุฑุฉ...');
            
            const crusherId = 1;
            
            try {
                log(`๐ค ุฅุฑุณุงู GET ุฅูู: ${API_BASE}/crushers/${crusherId}`);
                
                const response = await fetch(`${API_BASE}/crushers/${crusherId}`);
                
                log(`๐ฅ ุงุณุชุฌุงุจุฉ HTTP: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`โ ุฎุทุฃ ูู ุงูุงุณุชุฌุงุจุฉ: ${errorText}`);
                    return;
                }
                
                const result = await response.json();
                log(`โ ูุฌุญ ุฌูุจ ุจูุงูุงุช ุงููุณุงุฑุฉ!`);
                
                if (result.payments && result.payments.length > 0) {
                    log(`๐ ุนุฏุฏ ุงูุฏูุนุงุช: ${result.payments.length}`);
                    log(`๐ ุฃูู ุฏูุนุฉ: ${JSON.stringify(result.payments[0], null, 2)}`);
                    
                    // Check column names in fetched data
                    const firstPayment = result.payments[0];
                    if (firstPayment.payment_method) {
                        log(`โ ุงูุจูุงูุงุช ุชุญุชูู ุนูู payment_method: ${firstPayment.payment_method}`);
                    } else if (firstPayment.method) {
                        log(`โ๏ธ ุงูุจูุงูุงุช ุชุญุชูู ุนูู method: ${firstPayment.method}`);
                    } else {
                        log(`โ ูุง ุชูุฌุฏ ูุนูููุงุช ุทุฑููุฉ ุงูุฏูุน`);
                    }
                } else {
                    log(`๐ ูุง ุชูุฌุฏ ุฏูุนุงุช ูููุณุงุฑุฉ`);
                }
                
            } catch (error) {
                log(`โ ุฎุทุฃ ูู ุงูุดุจูุฉ: ${error.message}`);
            }
        }
        
        async function testCrusherDetails() {
            clearLog();
            log('๐งช ุงุฎุชุจุงุฑ ุชูุงุตูู ุงููุณุงุฑุฉ...');
            
            try {
                // Test if crusher details page loads without errors
                log(`๐ ูุชุญ ุตูุญุฉ ุชูุงุตูู ุงููุณุงุฑุฉ...`);
                log(`๐ URL: crusher-details.html?id=1`);
                log(`๐ก ุงูุชุญ ุงูุฑุงุจุท ูู ุชุจููุจ ุฌุฏูุฏ ูุชุญูู ูู:`);
                log(`   - ูู ุชูุญูู ุงูุตูุญุฉ ุจุฏูู ุฃุฎุทุงุกุ`);
                log(`   - ูู ุชุธูุฑ ุงูุฏูุนุงุช ุจุดูู ุตุญูุญุ`);
                log(`   - ูู ูููู ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉุ`);
                
                // Test the API endpoint directly
                const response = await fetch(`${API_BASE}/crushers/1`);
                if (response.ok) {
                    log(`โ API endpoint ูุนูู ุจุดูู ุตุญูุญ`);
                } else {
                    log(`โ API endpoint ูุง ูุนูู: ${response.status}`);
                }
                
            } catch (error) {
                log(`โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ: ${error.message}`);
            }
        }
        
        // Test on page load
        window.addEventListener('load', () => {
            log('๐ ุตูุญุฉ ุงุฎุชุจุงุฑ ุฏูุนุงุช ุงููุณุงุฑุงุช ุฌุงูุฒุฉ');
            log(`๐ API Base URL: ${API_BASE}`);
            log('๐ก ุงููุฑ ุนูู ุงูุฃุฒุฑุงุฑ ุฃุนูุงู ูุงุฎุชุจุงุฑ ุงูุฅุตูุงุญุงุช');
            log('');
            log('๐ง ุงูุฅุตูุงุญ ุงููุทุจู:');
            log('- ุชู ุชุบููุฑ method ุฅูู payment_method ูู crusher payments');
            log('- ุชู ุฅุตูุงุญ ูู ูู POST ู PUT routes');
            log('- ุงูุขู ูุชูุงูู ูุน schema ูุงุนุฏุฉ ุงูุจูุงูุงุช');
        });
    </script>
</body>
</html>