<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>إدخال تسليم جديد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Cairo:400,700,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            background: #f6f7fb;
            color: #232323;
            margin: 0;
            padding: 0;
            direction: rtl;
        }

        /* Sidebar styles */
        .sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: 225px;
            height: 100vh;
            background: #1f365c;
            color: #fff;
            box-shadow: -2px 0 16px #0001;
            display: flex;
            flex-direction: column;
            z-index: 300;
            transition: right 0.25s;
        }

        .sidebar .app-title {
            font-size: 1.38rem;
            font-weight: 700;
            text-align: center;
            margin: 23px 0 28px 0;
            letter-spacing: 1px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0 0 0 0;
            margin: 0;
            flex: 1;
        }

        .sidebar li {
            margin: 0;
            padding: 0;
        }

        .sidebar a {
            display: block;
            color: #e4e9f6;
            text-decoration: none;
            font-size: 1.07rem;
            padding: 15px 29px;
            border-right: 4px solid transparent;
            transition: background 0.13s, color 0.13s, border-color 0.13s;
            font-weight: 500;
        }

        .sidebar a.active,
        .sidebar a:focus {
            background: #284b71;
            color: #fff;
            border-right: 4px solid #3e82dc;
        }

        .sidebar a:hover {
            background: #27406b;
            color: #f5faff;
        }

        .sidebar .sidenav-spacer {
            flex: 1;
        }

        /* Hamburger Button */
        .hamburger {
            display: none;
            position: fixed;
            right: 16px;
            top: 14px;
            width: 40px;
            height: 40px;
            z-index: 310;
            background: #1f365c;
            border-radius: 7px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 7px #18518c17;
        }

        .hamburger span,
        .hamburger span:before,
        .hamburger span:after {
            display: block;
            width: 24px;
            height: 3.3px;
            background: #fff;
            border-radius: 2px;
            position: absolute;
        }

        .hamburger span {
            position: relative;
        }

        .hamburger span:before {
            content: "";
            position: absolute;
            top: -8px;
        }

        .hamburger span:after {
            content: "";
            position: absolute;
            top: 8px;
        }

        @media (max-width: 900px) {
            .sidebar {
                width: 190px;
            }
        }

        @media (max-width: 700px) {
            .sidebar {
                right: -210px;
                width: 180px;
                box-shadow: none;
            }

            .sidebar.open {
                right: 0;
                box-shadow: -2px 0 14px #0003;
            }

            .hamburger {
                display: flex;
            }
        }

        .main-content {
            margin-right: 225px;
            padding: 31px 28px 28px 28px;
            min-height: 100vh;
            transition: margin-right 0.25s;
        }

        @media (max-width: 900px) {
            .main-content {
                margin-right: 190px;
                padding: 19px 10px 10px 10px;
            }
        }

        @media (max-width: 700px) {
            .main-content {
                margin-right: 0;
                padding: 16px 4vw;
            }
        }

        .page-header {
            font-size: 2.1rem;
            font-weight: 800;
            color: #1b3c66;
            letter-spacing: 0.01em;
            margin-bottom: 28px;
            text-align: center;
        }

        .new-entry-form-container {
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 2px 20px #28527a13;
            max-width: 560px;
            margin: 0 auto;
            padding: 26px 25px 23px 25px;
        }

        form label {
            display: block;
            font-size: 1.11rem;
            font-weight: 700;
            color: #2c4564;
            margin-bottom: 7px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 9px 13px;
            border-radius: 7px;
            border: 1px solid #a2b4c9;
            font-size: 1.05rem;
            background: #f5f7fa;
            color: #24416e;
            transition: border 0.13s;
            font-family: 'Cairo', Arial, sans-serif;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: #5397d7;
            outline: none;
        }

        .flex-row {
            display: flex;
            gap: 13px;
        }

        @media(max-width: 540px) {
            .flex-row {
                flex-direction: column;
                gap: 0;
            }
        }

        .discount-options {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 25px;
            position: relative;
        }

        @media (max-width: 490px) {
            .discount-options {
                flex-direction: column;
                gap: 0;
                align-items: flex-start;
            }
        }

        .discount-extra-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            align-items: stretch;
            gap: 26px 24px;
            margin-bottom: 20px;
            background: linear-gradient(120deg, #fffceb 65%, #ffe699 100%);
            border: 2.5px solid #ffc34b;
            border-radius: 24px;
            padding: 24px 13px 18px 13px;
            box-shadow: 0 10px 38px #fedb303a;
            position: relative;
            border-top: 6px solid #ffc107;
            border-bottom: 4px solid #ffecb3;
            box-shadow: 0 0.5rem 2.2rem #ffe79935, 0 1px 10px #ffd65c26;
            transition: box-shadow 0.18s, border 0.18s;
            outline: 2.7px dotted #ffd24b;
            outline-offset: -8px;
            /* Hidden by default, enabled with .active */
            display: none;
        }

        .discount-extra-fields.active {
            display: flex;
        }

        .radio-label {
            font-weight: 500;
            font-size: 1.04rem;
            color: #174368;
            margin-right: 8px;
        }

        .save-btn {
            background: #28527a;
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 13px 15px;
            font-size: 1.19rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 1px 6px #28527a11;
            transition: background 0.16s;
            width: 100%;
            margin-top: 12px;
        }

        .save-btn:hover,
        .save-btn:focus {
            background: #1b3c66;
        }

        .form-error {
            color: #c62828;
            font-size: 1rem;
            margin-top: -12px;
            margin-bottom: 13px;
            display: none;
        }

        /* Hide native spinners on number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .required {
            color: #e64444;
            font-size: 1.13em;
            margin-right: 2px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <!-- Hamburger menu for mobile -->
    <button class="hamburger" id="sidebarHamburger" aria-label="القائمة الجانبية">
        <span></span>
    </button>
    <!-- Sidebar navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="app-title">نظام التوزيع</div>
        <ul>
            <li><a href="dashboard.html">لوحة التحكم</a></li>
            <li><a href="clients.html">العملاء</a></li>
            <li><a href="crushers.html">الكسارات</a></li>
            <li><a href="contractors.html">مقاولين العجل</a></li>
            <li><a href="new-entry.html" class="active">تسليم جديد</a></li>
        </ul>
        <div class="sidenav-spacer"></div>
    </nav>
    <div class="main-content">
        <div class="page-header">إدخال تسليم جديد</div>
        <div class="new-entry-form-container">
            <form id="newEntryForm" autocomplete="off" novalidate>
                <div id="formError" class="form-error"></div>
                <div class="form-group">
                    <label for="client"><span class="required">*</span>العميل</label>
                    <select id="client" required>
                        <option value="">اختر العميل</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="material"><span class="required">*</span>نوع المادة</label>
                    <select id="material" required>
                        <option value="">اختر النوع</option>
                        <option value="رمل">رمل</option>
                        <option value="دفان">دفان</option>
                        <option value="حصى">حصى</option>
                        <option value="بسكورس">بسكورس</option>
                        <option value="صبيز">صبيز</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="crusher"><span class="required">*</span>الكسارة</label>
                    <select id="crusher" required>
                        <option value="">اختر الكسارة</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="voucher"><span class="required">*</span>رقم البون</label>
                    <input type="text" id="voucher" required maxlength="32" />
                </div>

                <div class="form-group">
                    <label for="wheelContractor"><span class="required">*</span>مقاول النقل</label>
                    <select id="wheelContractor" required>
                        <option value="">اختر المقاول</option>
                    </select>
                </div>

                <div class="form-group flex-row">
                    <div style="flex:1;">
                        <label for="driver"><span class="required">*</span>اسم السائق</label>
                        <input type="text" id="driver" required maxlength="48" />
                    </div>
                    <div style="flex:1;">
                        <label for="carHead"><span class="required">*</span>رقم الرأس</label>
                        <input type="text" id="carHead" required maxlength="28" />
                    </div>
                    <div style="flex:1;">
                        <label for="carTail"><span class="required">*</span>رقم المقطورة</label>
                        <input type="text" id="carTail" required maxlength="28" />
                    </div>
                </div>
                <div style="flex:1;">
                    <label for="carVolume"><span class="required">*</span>تكعيب السيارة (م³)</label>
                    <input type="number" id="carVolume" min="0.01" step="0.01" required />
                </div>

                <div class="form-group">
                    <div class="discount-options">
                        <label class="radio-label">
                            <input type="radio" name="discount" id="discountYes" value="yes" /> خصم
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="discount" id="discountNo" value="no" checked /> بدون خصم
                        </label>
                    </div>
                    <div class="form-group special-deduct" id="deductAmountField" style="display:none;
                        background: linear-gradient(92deg, #e1ecf7 65%, #b6dbef 100%);
                        border: 2.5px dashed #247ae0;
                        border-radius: 10px;
                        padding: 23px 18px 9px 18px;
                        margin: 13px 0 18px 0;
                        box-shadow: 0 4px 12px #247ae020;
                        text-align: right;
                        position: relative;">
                        <label for="deductAmount"
                            style="font-weight:800;font-size:1.11rem;color:#17406b;margin-bottom:11px;display:block;">
                            <span class="required" style="color:#c0392b;font-weight:900;">*</span>
                            قيمة الخصم (م³)
                            <span
                                style="background:#fff8e1;color:#b27b21;padding:2px 8px 2px 8px;border-radius:13px;font-size:0.93em;margin-right:7px;">خاص</span>
                        </label>
                        <input type="number" id="deductAmount" min="0" step="0.01" style="background: #fffde9; border: 1.7px solid #e2be71; border-radius:7px;
                               font-weight:700; color:#bb8300; font-size:1.13em; width: 60%;
                               box-shadow: 0 2px 7px #fffdd430; outline: none; padding:7px 16px;" />
                        <span
                            style="position:absolute;left:13px;top:14px;color:#b6dbef;font-size:1.1rem;font-weight:700;">
                            م³
                        </span>
                    </div>

                    <div class="form-group flex-row">
                        <div style="flex:1;">
                            <label for="quantity"><span class="required">*</span>كمية الحمولة (م³)</label>
                            <input type="number" id="quantity" min="0.01" step="0.01" required />
                        </div>
                        <div style="flex:1;">
                            <label for="price"><span class="required">*</span>السعر لكل م³</label>
                            <input type="number" id="price" min="0" step="0.01" required />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="contractorCharge">مستحق مقاول النقل (اختياري)</label>
                        <input type="number" id="contractorCharge" min="0" step="0.01" placeholder="مثال: 2500" />
                    </div>

                    <div class="form-group">
                        <label for="total">الإجمالي</label>
                        <input type="text" id="total" readonly
                            style="background:#eaf2fa;color:#1c546b;font-weight:600;" />
                    </div>



                    <button type="submit" class="save-btn">حفظ البيانات</button>
            </form>
        </div>
    </div>
    <script src="/env.js"></script>
    <script>
        const API_BASE = (function () {
            if (window.__API_BASE__) return window.__API_BASE__;
            try { const origin = window.location.origin; if (!origin || origin === 'null') return 'http://localhost:5000/api'; return origin.replace(/\/$/, '') + '/api'; } catch (e) { return 'http://localhost:5000/api'; }
        })();

        // Hamburger menu behavior
        const sidebar = document.getElementById('sidebar');
        const hamburger = document.getElementById('sidebarHamburger');
        hamburger.addEventListener('click', function () {
            sidebar.classList.toggle('open');
        });
        document.body.addEventListener('click', function (e) {
            if (window.innerWidth <= 700 && sidebar.classList.contains('open')) {
                if (!sidebar.contains(e.target) && e.target !== hamburger) {
                    sidebar.classList.remove('open');
                }
            }
        });
        window.addEventListener('resize', function () {
            if (window.innerWidth > 700 && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }
        });

        async function populateSelect(id, data, placeholder) {
            const select = document.getElementById(id);
            select.innerHTML = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = placeholder;
            select.appendChild(defaultOpt);
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.name;
                select.appendChild(opt);
            });
        }

        async function loadDropdowns() {
            try {
                const [clients, crushers, contractors] = await Promise.all([
                    fetch(`${API_BASE}/clients`).then(r => r.json()),
                    fetch(`${API_BASE}/crushers`).then(r => r.json()),
                    fetch(`${API_BASE}/contractors`).then(r => r.json())
                ]);
                populateSelect('client', clients, 'اختر العميل');
                populateSelect('crusher', crushers, 'اختر الكسارة');
                populateSelect('wheelContractor', contractors, 'اختر المقاول');
            } catch (err) {
                console.error(err);
                const errorDiv = document.getElementById('formError');
                errorDiv.textContent = 'تعذر تحميل البيانات الأساسية';
                errorDiv.style.display = 'block';
            }
        }

        // Discount fields toggle
        const discountYes = document.getElementById('discountYes');
        const discountNo = document.getElementById('discountNo');
        const deductAmountField = document.getElementById('deductAmountField');
        discountYes.addEventListener('change', () => {
            if (discountYes.checked) {
                deductAmountField.style.display = '';
                document.getElementById('deductAmount').required = true;
            }
            calcTotal();
        });
        discountNo.addEventListener('change', () => {
            if (discountNo.checked) {
                deductAmountField.style.display = 'none';
                const d = document.getElementById('deductAmount');
                d.required = false;
                d.value = "";
            }
            calcTotal();
        });

        // Auto-calculate total (net quantity * price)
        function calcTotal() {
            const q = parseFloat(document.getElementById('quantity').value);
            const p = parseFloat(document.getElementById('price').value);
            const deduct = discountYes.checked ? parseFloat(document.getElementById('deductAmount').value) || 0 : 0;
            let total = 0;
            if (!isNaN(q) && !isNaN(p)) {
                const net = Math.max(q - Math.max(deduct, 0), 0);
                total = net * p;
            }
            document.getElementById('total').value = (total > 0 ? total.toLocaleString('ar-EG', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '');
        }
        document.getElementById('quantity').addEventListener('input', calcTotal);
        document.getElementById('price').addEventListener('input', calcTotal);
        document.getElementById('deductAmount').addEventListener('input', calcTotal);

        // Form submission
        document.getElementById('newEntryForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            let valid = true;
            let err = "";

            const requiredFields = [
                { id: 'client', msg: 'يرجى اختيار العميل' },
                { id: 'material', msg: 'يرجى اختيار نوع المادة' },
                { id: 'crusher', msg: 'يرجى اختيار الكسارة' },
                { id: 'voucher', msg: 'يرجى إدخال رقم البون' },
                { id: 'wheelContractor', msg: 'يرجى اختيار مقاول النقل' },
                { id: 'driver', msg: 'يرجى إدخال اسم السائق' },
                { id: 'carHead', msg: 'يرجى إدخال رقم الرأس' },
                { id: 'carTail', msg: 'يرجى إدخال رقم المقطورة' },
                { id: 'quantity', msg: 'يرجى إدخال كمية الحمولة', type: 'number' },
                { id: 'price', msg: 'يرجى إدخال السعر', type: 'number' },
                { id: 'carVolume', msg: 'يرجى إدخال تكعيب السيارة', type: 'number' }
            ];
            if (discountYes.checked) {
                requiredFields.push({ id: 'deductAmount', msg: 'يرجى تحديد قيمة الخصم', type: 'number' });
            }

            for (const f of requiredFields) {
                const el = document.getElementById(f.id);
                if (!el || !el.value || (el.value.trim && !el.value.trim())) {
                    valid = false;
                    err = f.msg;
                    break;
                }
                if (f.type === 'number' && (isNaN(parseFloat(el.value)) || parseFloat(el.value) <= 0)) {
                    valid = false;
                    err = f.msg;
                    break;
                }
            }

            const totalVal = document.getElementById('total').value;
            if (!totalVal || isNaN(parseFloat(totalVal.replace(/,/g, ''))) || parseFloat(totalVal.replace(/,/g, '')) < 0) {
                valid = false;
                err = "الإجمالي غير صالح";
            }
            const errorDiv = document.getElementById('formError');
            if (!valid) {
                errorDiv.textContent = err;
                errorDiv.style.display = "block";
                return false;
            }
            errorDiv.style.display = "none";

            const payload = {
                client_id: Number(document.getElementById('client').value),
                crusher_id: Number(document.getElementById('crusher').value) || null,
                contractor_id: Number(document.getElementById('wheelContractor').value) || null,
                material: document.getElementById('material').value,
                voucher: document.getElementById('voucher').value,
                quantity: parseFloat(document.getElementById('quantity').value),
                discount_volume: discountYes.checked ? (parseFloat(document.getElementById('deductAmount').value) || 0) : 0,
                price_per_meter: parseFloat(document.getElementById('price').value),
                driver_name: document.getElementById('driver').value,
                car_head: document.getElementById('carHead').value,
                car_tail: document.getElementById('carTail').value,
                car_volume: parseFloat(document.getElementById('carVolume').value) || null,
                contractor_charge: parseFloat(document.getElementById('contractorCharge').value) || 0
            };

            try {
                const resp = await fetch(`${API_BASE}/deliveries`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) {
                    const msg = await resp.text();
                    throw new Error(msg || 'فشل الحفظ');
                }
                await Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم حفظ التسليم بنجاح',
                    confirmButtonText: 'حسناً'
                });
                this.reset();
                document.getElementById('total').value = '';
                deductAmountField.style.display = 'none';
                document.getElementById('deductAmount').required = false;
            } catch (errResp) {
                console.error(errResp);
                errorDiv.textContent = 'تعذر حفظ التسليم';
                errorDiv.style.display = "block";
            }
            return false;
        });

        loadDropdowns();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>