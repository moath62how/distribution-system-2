const API_BASE = (function () {
    if (window.__API_BASE__) return window.__API_BASE__;
    try {
        const origin = window.location.origin;
        if (!origin || origin === 'null') return 'http://localhost:5000/api';
        return origin.replace(/\/$/, '') + '/api';
    } catch (e) {
        return 'http://localhost:5000/api';
    }
})();

// State
let clientData = null;
let allDeliveries = [];
let allPayments = [];
let allAdjustments = [];

// Helpers
function getClientIdFromURL() {
    return new URLSearchParams(window.location.search).get('id');
}

function formatCurrency(amount) {
    return Number(amount || 0).toLocaleString('ar-EG', {
        style: 'currency',
        currency: 'EGP',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function formatQuantity(amount) {
    return Number(amount || 0).toLocaleString('ar-EG', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Render Functions
function renderSummary(totals) {
    const container = document.getElementById('summaryGrid');
    const balance = totals.balance || 0;
    const openingBalance = totals.openingBalance || 0;
    
    // Balance logic: Positive = they owe us (GREEN), Negative = we owe them (RED)
    const balanceClass = balance > 0 ? 'text-success' : balance < 0 ? 'text-danger' : '';
    const balanceLabel = balance > 0 ? '(Ø¹Ù„ÙŠÙ‡ )' : balance < 0 ? '(Ù„Ù‡ )' : '';
    
    // Opening balance logic: Negative = they owe us (GREEN), Positive = we owe them (RED)
    const openingClass = openingBalance < 0 ? 'text-success' : openingBalance > 0 ? 'text-danger' : '';
    const openingLabel = openingBalance < 0 ? '(Ø¹Ù„ÙŠÙ‡)' : openingBalance > 0 ? '(Ù„Ù‡)' : '';
    
    container.innerHTML = `
        <div class="summary-item">
            <div class="summary-value ${openingClass}">${formatCurrency(Math.abs(openingBalance))} ${openingLabel}</div>
            <div class="summary-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</div>
        </div>
        <div class="summary-item">
            <div class="summary-value text-success">${formatCurrency(totals.totalDeliveries || 0)}</div>
            <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØ±ÙŠØ¯Ø§Øª</div>
        </div>
        <div class="summary-item">
            <div class="summary-value text-danger">${formatCurrency(totals.totalPayments || 0)}</div>
            <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</div>
        </div>
        <div class="summary-item">
            <div class="summary-value ${totals.totalAdjustments > 0 ? 'text-success' : totals.totalAdjustments < 0 ? 'text-danger' : ''}">${formatCurrency(Math.abs(totals.totalAdjustments || 0))} ${totals.totalAdjustments > 0 ? '(Ø¹Ù„ÙŠÙ‡)' : totals.totalAdjustments < 0 ? '(Ù„Ù‡)' : ''}</div>
            <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</div>
        </div>
        <div class="summary-item">
            <div class="summary-value ${balanceClass}">${formatCurrency(Math.abs(balance))} ${balanceLabel}</div>
            <div class="summary-label">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ</div>
        </div>
    `;
}

function renderMaterials(materialTotals) {
    const container = document.getElementById('materialsContainer');
    
    if (!materialTotals || materialTotals.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“¦</div>
                <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ§Ø¯</div>
            </div>
        `;
        return;
    }

    container.innerHTML = '';
    materialTotals.forEach(material => {
        const card = document.createElement('div');
        card.className = 'material-card';
        card.innerHTML = `
            <div class="material-title">${material.material}</div>
            <div class="material-stat">
                <span>Ø§Ù„ÙƒÙ…ÙŠØ©:</span>
                <strong>${formatQuantity(material.totalQty)} Ù…Â³</strong>
            </div>
            <div class="material-stat">
                <span>Ø§Ù„Ù‚ÙŠÙ…Ø©:</span>
                <strong>${formatCurrency(material.totalValue)}</strong>
            </div>
        `;
        container.appendChild(card);
    });
}

function renderDeliveries(deliveries) {
    const container = document.getElementById('deliveriesContainer');
    
    if (!deliveries || deliveries.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸšš</div>
                <div>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ù„ÙŠÙ…Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>
            </div>
        `;
        return;
    }

    const table = document.createElement('table');
    table.className = 'table';
    
    // Header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = [
        'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„ÙƒØ³Ø§Ø±Ø©', 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„', 'Ø§Ù„Ù…Ø§Ø¯Ø©', 'Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙ†', 
        'ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ù…ÙˆÙ„Ø© (Ù…Â³)', 'Ø³Ø¹Ø± Ø§Ù„Ù…ØªØ±', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ'
    ];
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Body
    const tbody = document.createElement('tbody');
    deliveries.forEach(delivery => {
        const row = document.createElement('tr');
        
        const cells = [
            formatDate(delivery.created_at),
            delivery.crusher_name || '-',
            delivery.contractor_name || '-',
            delivery.material || '-',
            delivery.voucher || '-',
            formatQuantity(delivery.quantity) + ' Ù…Â³', // Only quantity, not net_quantity
            formatCurrency(delivery.price_per_meter),
            formatCurrency(delivery.total_value)
        ];
        
        cells.forEach(cellText => {
            const td = document.createElement('td');
            td.textContent = cellText;
            row.appendChild(td);
        });
        
        tbody.appendChild(row);
    });
    table.appendChild(tbody);
    
    container.innerHTML = '';
    container.appendChild(table);
}

function renderPayments(payments) {
    const container = document.getElementById('paymentsContainer');
    
    if (!payments || payments.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ’°</div>
                <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>
            </div>
        `;
        return;
    }

    const table = document.createElement('table');
    table.className = 'table';
    
    // Header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', 'Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', 'Ø§Ù„ØµÙˆØ±Ø©', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'];
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Body
    const tbody = document.createElement('tbody');
    payments.forEach(payment => {
        const row = document.createElement('tr');
        
        const cells = [
            formatDate(payment.paid_at),
            formatCurrency(payment.amount),
            payment.method || '-',
            payment.details || '-',
            payment.note || '-'
        ];
        
        cells.forEach(cellText => {
            const td = document.createElement('td');
            td.textContent = cellText;
            row.appendChild(td);
        });
        
        // Image cell
        const imageCell = document.createElement('td');
        if (payment.payment_image) {
            const imageBtn = document.createElement('button');
            imageBtn.className = 'btn btn-sm btn-secondary';
            imageBtn.title = 'Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©';
            imageBtn.innerHTML = 'ğŸ–¼ï¸ Ø¹Ø±Ø¶';
            imageBtn.setAttribute('data-image', payment.payment_image);
            imageBtn.onclick = function() {
                const imageData = this.getAttribute('data-image');
                showImageModal(imageData);
            };
            imageCell.appendChild(imageBtn);
        } else {
            imageCell.textContent = '-';
        }
        row.appendChild(imageCell);
        
        // Actions cell
        const actionsCell = document.createElement('td');
        actionsCell.innerHTML = `
            <button class="btn btn-sm btn-secondary" onclick="editPayment(${payment.id})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
            <button class="btn btn-sm btn-danger" onclick="deletePayment(${payment.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
        `;
        row.appendChild(actionsCell);
        
        tbody.appendChild(row);
    });
    table.appendChild(tbody);
    
    container.innerHTML = '';
    container.appendChild(table);
}

function renderAdjustments(adjustments) {
    const container = document.getElementById('adjustmentsContainer');
    
    if (!adjustments || adjustments.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">âš–ï¸</div>
                <div>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³ÙˆÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</div>
            </div>
        `;
        return;
    }

    const table = document.createElement('table');
    table.className = 'table';
    
    // Header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = ['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ù…Ø¨Ù„Øº', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ³ÙˆÙŠØ©', 'Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ø³Ø¨Ø¨', 'Ø§Ù„ØµÙˆØ±Ø©', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'];
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Body
    const tbody = document.createElement('tbody');
    adjustments.forEach(adjustment => {
        const row = document.createElement('tr');
        
        const amountCell = document.createElement('td');
        const amount = adjustment.amount || 0;
        
        // Positive adjustment = for us (GREEN), Negative adjustment = against us (RED)
        amountCell.className = amount > 0 ? 'text-success' : amount < 0 ? 'text-danger' : '';
        const label = amount > 0 ? '(Ù„Ù†Ø§)' : amount < 0 ? '(Ø¹Ù„ÙŠÙ†Ø§)' : '';
        amountCell.textContent = `${formatCurrency(Math.abs(amount))} ${label}`;
        
        const cells = [
            formatDate(adjustment.created_at),
            amountCell,
            adjustment.method || '-',
            adjustment.details || '-',
            adjustment.reason || '-'
        ];
        
        cells.forEach((cell, index) => {
            if (index === 1) {
                row.appendChild(cell);
            } else {
                const td = document.createElement('td');
                td.textContent = cell;
                row.appendChild(td);
            }
        });
        
        // Image cell
        const imageCell = document.createElement('td');
        if (adjustment.payment_image) {
            imageCell.innerHTML = `
                <button class="btn btn-sm btn-secondary" data-image="${adjustment.payment_image}" onclick="showImageModal(this.getAttribute('data-image'))" title="Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©">
                    ï¿½ï¸ Ø¹Ø±Ø¶
                </button>
            `;
        } else {
            imageCell.textContent = '-';
        }
        row.appendChild(imageCell);
        
        // Actions cell
        const actionsCell = document.createElement('td');
        actionsCell.innerHTML = `
            <button class="btn btn-sm btn-secondary" onclick="editAdjustment(${adjustment.id})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
            <button class="btn btn-sm btn-danger" onclick="deleteAdjustment(${adjustment.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
        `;
        row.appendChild(actionsCell);
        
        tbody.appendChild(row);
    });
    table.appendChild(tbody);
    
    container.innerHTML = '';
    container.appendChild(table);
}

// Modal Functions
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        
        // Clear any previous messages
        const messageElements = modal.querySelectorAll('[id$="Message"]');
        messageElements.forEach(el => el.innerHTML = '');
        
        // Reset form to add mode if not already in edit mode
        if (modalId === 'paymentModal') {
            const form = document.getElementById('paymentForm');
            if (!form.dataset.editId) {
                resetPaymentForm();
            }
        } else if (modalId === 'adjustmentModal') {
            const form = document.getElementById('adjustmentForm');
            if (!form.dataset.editId) {
                resetAdjustmentForm();
            }
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        
        // Clear messages when closing
        const messageElements = modal.querySelectorAll('[id$="Message"]');
        messageElements.forEach(el => el.innerHTML = '');
        
        // Always reset forms when closing
        if (modalId === 'paymentModal') {
            resetPaymentForm();
        } else if (modalId === 'adjustmentModal') {
            resetAdjustmentForm();
        }
    }
}

function resetPaymentForm() {
    const form = document.getElementById('paymentForm');
    form.reset();
    delete form.dataset.editId;
    
    // Reset UI elements
    document.getElementById('paymentDetailsGroup').style.display = 'none';
    document.getElementById('paymentImageGroup').style.display = 'none';
    document.getElementById('paymentDetails').required = false;
    document.getElementById('paymentImagePreview').innerHTML = '';
    
    // Reset modal title and button
    document.querySelector('#paymentModal .modal-header').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©';
    document.querySelector('#paymentForm button[type="submit"]').textContent = 'Ø¥Ø¶Ø§ÙØ©';
    
    // Set default date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('paymentDate').value = today;
}

function resetAdjustmentForm() {
    const form = document.getElementById('adjustmentForm');
    form.reset();
    delete form.dataset.editId;
    
    // Reset UI elements
    document.getElementById('adjustmentDetailsGroup').style.display = 'none';
    document.getElementById('adjustmentImageGroup').style.display = 'none';
    document.getElementById('adjustmentDetails').required = false;
    document.getElementById('adjustmentImagePreview').innerHTML = '';
    
    // Reset modal title and button
    document.querySelector('#adjustmentModal .modal-header').textContent = 'Ø¥Ø¶Ø§ÙØ© ØªØ³ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©';
    document.querySelector('#adjustmentForm button[type="submit"]').textContent = 'Ø¥Ø¶Ø§ÙØ©';
}

function showMessage(elementId, message, type) {
    const msgDiv = document.getElementById(elementId);
    if (msgDiv) {
        msgDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }
}

// CRUD Functions
async function editPayment(paymentId) {
    try {
        // Find payment in current data
        const payment = allPayments.find(p => p.id === paymentId);
        if (!payment) {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹Ø©');
            return;
        }
        
        // Populate form with existing data
        document.getElementById('paymentAmount').value = payment.amount;
        document.getElementById('paymentMethod').value = payment.method || '';
        document.getElementById('paymentDetails').value = payment.details || '';
        document.getElementById('paymentDate').value = payment.paid_at ? payment.paid_at.split('T')[0] : '';
        document.getElementById('paymentNote').value = payment.note || '';
        
        // Show/hide details field based on method
        const detailsGroup = document.getElementById('paymentDetailsGroup');
        const detailsInput = document.getElementById('paymentDetails');
        if (['Ø¨Ù†ÙƒÙŠ', 'Ø´ÙŠÙƒ', 'Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ', 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'].includes(payment.method)) {
            detailsGroup.style.display = 'block';
            detailsInput.required = true;
        }
        
        // Change form to edit mode
        const form = document.getElementById('paymentForm');
        form.dataset.editId = paymentId;
        document.querySelector('#paymentModal .modal-header').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©';
        document.querySelector('#paymentForm button[type="submit"]').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
        
        showModal('paymentModal');
    } catch (error) {
        console.error('Error editing payment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø©');
    }
}

async function deletePayment(paymentId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ')) {
        return;
    }
    
    try {
        const clientId = getClientIdFromURL();
        const response = await fetch(`${API_BASE}/clients/${clientId}/payments/${paymentId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©');
        }
        
        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
        loadClientDetails(); // Reload data
    } catch (error) {
        console.error('Error deleting payment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©');
    }
}

async function editAdjustment(adjustmentId) {
    try {
        // Find adjustment in current data
        const adjustment = allAdjustments.find(a => a.id === adjustmentId);
        if (!adjustment) {
            alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ³ÙˆÙŠØ©');
            return;
        }
        
        // Populate form with existing data
        document.getElementById('adjustmentAmount').value = adjustment.amount;
        document.getElementById('adjustmentMethod').value = adjustment.method || '';
        document.getElementById('adjustmentDetails').value = adjustment.details || '';
        document.getElementById('adjustmentReason').value = adjustment.reason || '';
        
        // Show/hide details field based on method
        const detailsGroup = document.getElementById('adjustmentDetailsGroup');
        const detailsInput = document.getElementById('adjustmentDetails');
        if (['Ø¨Ù†ÙƒÙŠ', 'Ø´ÙŠÙƒ', 'Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ', 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'].includes(adjustment.method)) {
            detailsGroup.style.display = 'block';
            detailsInput.required = true;
        }
        
        // Change form to edit mode
        const form = document.getElementById('adjustmentForm');
        form.dataset.editId = adjustmentId;
        document.querySelector('#adjustmentModal .modal-header').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ©';
        document.querySelector('#adjustmentForm button[type="submit"]').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
        
        showModal('adjustmentModal');
    } catch (error) {
        console.error('Error editing adjustment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠØ©');
    }
}

async function deleteAdjustment(adjustmentId) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØªØ³ÙˆÙŠØ©ØŸ')) {
        return;
    }
    
    try {
        const clientId = getClientIdFromURL();
        const response = await fetch(`${API_BASE}/clients/${clientId}/adjustments/${adjustmentId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ³ÙˆÙŠØ©');
        }
        
        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ³ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        loadClientDetails(); // Reload data
    } catch (error) {
        console.error('Error deleting adjustment:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ³ÙˆÙŠØ©');
    }
}

async function updatePayment(paymentId, paymentData) {
    const clientId = getClientIdFromURL();
    const response = await fetch(`${API_BASE}/clients/${clientId}/payments/${paymentId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paymentData)
    });
    
    if (!response.ok) {
        let errorMessage = 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹Ø©';
        try {
            const responseClone = response.clone();
            const errorData = await responseClone.json();
            errorMessage = errorData.message || errorMessage;
        } catch (parseError) {
            try {
                const errorText = await response.text();
                if (errorText) errorMessage = errorText;
            } catch (textError) {
                console.log('Could not read error response');
            }
        }
        throw new Error(errorMessage);
    }
    
    return response.json();
}

async function updateAdjustment(adjustmentId, adjustmentData) {
    const clientId = getClientIdFromURL();
    const response = await fetch(`${API_BASE}/clients/${clientId}/adjustments/${adjustmentId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(adjustmentData)
    });
    
    if (!response.ok) {
        let errorMessage = 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³ÙˆÙŠØ©';
        try {
            const responseClone = response.clone();
            const errorData = await responseClone.json();
            errorMessage = errorData.message || errorMessage;
        } catch (parseError) {
            try {
                const errorText = await response.text();
                if (errorText) errorMessage = errorText;
            } catch (textError) {
                console.log('Could not read error response');
            }
        }
        throw new Error(errorMessage);
    }
    
    return response.json();
}
async function addPayment(clientId, paymentData) {
    console.log('Sending payment data:', paymentData);
    console.log('Sending payment request to:', `${API_BASE}/clients/${clientId}/payments`);
    console.log('Payment data:', paymentData);
    
    const response = await fetch(`${API_BASE}/clients/${clientId}/payments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paymentData)
    });
    
    console.log('Response status:', response.status);
    console.log('Response headers:', response.headers);
    
    if (!response.ok) {
        let errorMessage = 'ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©';
        try {
            const responseClone = response.clone();
            const errorData = await responseClone.json();
            errorMessage = errorData.message || errorMessage;
        } catch (parseError) {
            console.log('Could not parse error response as JSON');
            try {
                const errorText = await response.text();
                console.log('Error response text:', errorText);
                if (errorText) errorMessage = errorText;
            } catch (textError) {
                console.log('Could not read error response as text');
            }
        }
        console.log('Payment API error:', errorMessage);
        throw new Error(errorMessage);
    }
    
    return response.json();
}

async function addAdjustment(clientId, adjustmentData) {
    console.log('Sending adjustment data:', adjustmentData);
    
    const response = await fetch(`${API_BASE}/clients/${clientId}/adjustments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(adjustmentData)
    });
    
    if (!response.ok) {
        let errorMessage = 'ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ³ÙˆÙŠØ©';
        try {
            const responseClone = response.clone();
            const errorData = await responseClone.json();
            errorMessage = errorData.message || errorMessage;
        } catch (parseError) {
            try {
                const errorText = await response.text();
                if (errorText) errorMessage = errorText;
            } catch (textError) {
                console.log('Could not read error response');
            }
        }
        throw new Error(errorMessage);
    }
    
    return response.json();
}

// Event Handlers
function setupEventHandlers() {
    // Add Payment Button
    document.getElementById('addPaymentBtn').addEventListener('click', () => {
        showModal('paymentModal');
    });
    
    // Add Adjustment Button
    document.getElementById('addAdjustmentBtn').addEventListener('click', () => {
        showModal('adjustmentModal');
    });
    
    // Payment method change handler
    document.getElementById('paymentMethod').addEventListener('change', (e) => {
        const detailsGroup = document.getElementById('paymentDetailsGroup');
        const imageGroup = document.getElementById('paymentImageGroup');
        const detailsInput = document.getElementById('paymentDetails');
        
        if (['Ø¨Ù†ÙƒÙŠ', 'Ø´ÙŠÙƒ', 'Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ', 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'].includes(e.target.value)) {
            detailsGroup.style.display = 'block';
            imageGroup.style.display = 'block';
            detailsInput.required = true;
            
            if (e.target.value === 'Ø´ÙŠÙƒ') {
                detailsInput.placeholder = 'Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ';
            } else if (e.target.value === 'Ø¨Ù†ÙƒÙŠ') {
                detailsInput.placeholder = 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø¨Ù†ÙƒÙŠØ©';
            } else {
                detailsInput.placeholder = 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            }
        } else {
            detailsGroup.style.display = 'none';
            imageGroup.style.display = 'none';
            detailsInput.required = false;
        }
    });
    
    // Adjustment method change handler
    document.getElementById('adjustmentMethod').addEventListener('change', (e) => {
        const detailsGroup = document.getElementById('adjustmentDetailsGroup');
        const imageGroup = document.getElementById('adjustmentImageGroup');
        const detailsInput = document.getElementById('adjustmentDetails');
        
        if (['Ø¨Ù†ÙƒÙŠ', 'Ø´ÙŠÙƒ', 'Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ', 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´'].includes(e.target.value)) {
            detailsGroup.style.display = 'block';
            imageGroup.style.display = 'block';
            detailsInput.required = true;
            
            if (e.target.value === 'Ø´ÙŠÙƒ') {
                detailsInput.placeholder = 'Ø±Ù‚Ù… Ø§Ù„Ø´ÙŠÙƒ';
            } else if (e.target.value === 'Ø¨Ù†ÙƒÙŠ') {
                detailsInput.placeholder = 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø¨Ù†ÙƒÙŠØ©';
            } else {
                detailsInput.placeholder = 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©';
            }
        } else {
            detailsGroup.style.display = 'none';
            imageGroup.style.display = 'none';
            detailsInput.required = false;
        }
    });
    
    // Payment Form
    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const clientId = getClientIdFromURL();
        const amount = document.getElementById('paymentAmount').value;
        const paid_at = document.getElementById('paymentDate').value;
        const note = document.getElementById('paymentNote').value;
        const method = document.getElementById('paymentMethod').value;
        const details = document.getElementById('paymentDetails').value;
        
        const paymentData = { amount, paid_at, note, method };
        if (details) paymentData.details = details;
        
        // Handle image upload
        const imageFile = document.getElementById('paymentImage').files[0];
        if (imageFile) {
            try {
                const payment_image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageFile);
                });
                paymentData.payment_image = payment_image;
            } catch (error) {
                console.error('Error reading image:', error);
                showMessage('paymentMessage', 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©', 'error');
                return;
            }
        }
        
        const form = e.target;
        const editId = form.dataset.editId;
        
        try {
            if (editId) {
                // Update existing payment
                await updatePayment(editId, paymentData);
                showMessage('paymentMessage', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                // Add new payment
                await addPayment(clientId, paymentData);
                showMessage('paymentMessage', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
            
            setTimeout(() => {
                closeModal('paymentModal');
                loadClientDetails(); // Reload data
            }, 1000);
        } catch (error) {
            console.error('Payment error:', error);
            showMessage('paymentMessage', error.message, 'error');
        }
    });
    
    // Adjustment Form
    document.getElementById('adjustmentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const clientId = getClientIdFromURL();
        const amount = document.getElementById('adjustmentAmount').value;
        const reason = document.getElementById('adjustmentReason').value;
        const method = document.getElementById('adjustmentMethod').value;
        const details = document.getElementById('adjustmentDetails').value;
        
        const adjustmentData = { amount, reason, method };
        if (details) adjustmentData.details = details;
        
        // Handle image upload
        const imageFile = document.getElementById('adjustmentImage').files[0];
        if (imageFile) {
            try {
                const payment_image = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(imageFile);
                });
                adjustmentData.payment_image = payment_image;
            } catch (error) {
                console.error('Error reading image:', error);
                showMessage('adjustmentMessage', 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©', 'error');
                return;
            }
        }
        
        const form = e.target;
        const editId = form.dataset.editId;
        
        try {
            if (editId) {
                // Update existing adjustment
                await updateAdjustment(editId, adjustmentData);
                showMessage('adjustmentMessage', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                // Add new adjustment
                await addAdjustment(clientId, adjustmentData);
                showMessage('adjustmentMessage', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ³ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
            
            setTimeout(() => {
                closeModal('adjustmentModal');
                loadClientDetails(); // Reload data
            }, 1000);
        } catch (error) {
            console.error('Adjustment error:', error);
            showMessage('adjustmentMessage', error.message, 'error');
        }
    });
    
    // Search and Sort functionality
    document.getElementById('deliveriesSearch').addEventListener('input', filterDeliveries);
    document.getElementById('deliveriesDateFrom').addEventListener('change', filterDeliveries);
    document.getElementById('deliveriesDateTo').addEventListener('change', filterDeliveries);
    document.getElementById('deliveriesSort').addEventListener('change', filterDeliveries);
    document.getElementById('paymentsSearch').addEventListener('input', filterPayments);
    document.getElementById('paymentsDateFrom').addEventListener('change', filterPayments);
    document.getElementById('paymentsDateTo').addEventListener('change', filterPayments);
    document.getElementById('paymentsSort').addEventListener('change', filterPayments);
    document.getElementById('adjustmentsSearch').addEventListener('input', filterAdjustments);
    document.getElementById('adjustmentsDateFrom').addEventListener('change', filterAdjustments);
    document.getElementById('adjustmentsDateTo').addEventListener('change', filterAdjustments);
    document.getElementById('adjustmentsSort').addEventListener('change', filterAdjustments);
    
    // Modal close on backdrop click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal.id);
            }
        });
    });
    
    // Image upload handlers
    document.getElementById('paymentImage').addEventListener('change', handleImageUpload);
    document.getElementById('adjustmentImage').addEventListener('change', handleImageUpload);
}

function handleImageUpload(e) {
    const file = e.target.files[0];
    const previewId = e.target.id === 'paymentImage' ? 'paymentImagePreview' : 'adjustmentImagePreview';
    const previewContainer = document.getElementById(previewId);
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
            previewContainer.innerHTML = `
                <div class="image-preview-container">
                    <img src="${event.target.result}" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©" class="image-preview">
                    <button type="button" class="remove-image" onclick="removeImage('${e.target.id}', '${previewId}')">&times;</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        previewContainer.innerHTML = '';
    }
}

function filterDeliveries() {
    const searchTerm = document.getElementById('deliveriesSearch').value.toLowerCase();
    const dateFrom = document.getElementById('deliveriesDateFrom').value;
    const dateTo = document.getElementById('deliveriesDateTo').value;
    const sortBy = document.getElementById('deliveriesSort').value;
    
    let filtered = allDeliveries.filter(delivery => {
        // Text search
        const matchesSearch = !searchTerm || 
            (delivery.crusher_name || '').toLowerCase().includes(searchTerm) ||
            (delivery.contractor_name || '').toLowerCase().includes(searchTerm) ||
            (delivery.material || '').toLowerCase().includes(searchTerm) ||
            (delivery.voucher || '').toLowerCase().includes(searchTerm);
        
        // Date filter
        const deliveryDate = new Date(delivery.created_at).toISOString().split('T')[0];
        const matchesDateFrom = !dateFrom || deliveryDate >= dateFrom;
        const matchesDateTo = !dateTo || deliveryDate <= dateTo;
        
        return matchesSearch && matchesDateFrom && matchesDateTo;
    });
    
    // Sort
    filtered.sort((a, b) => {
        switch (sortBy) {
            case 'date-asc':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'date-desc':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'value-asc':
                return (a.total_value || 0) - (b.total_value || 0);
            case 'value-desc':
                return (b.total_value || 0) - (a.total_value || 0);
            default:
                return 0;
        }
    });
    
    renderDeliveries(filtered);
}

function filterPayments() {
    const searchTerm = document.getElementById('paymentsSearch').value.toLowerCase();
    const dateFrom = document.getElementById('paymentsDateFrom').value;
    const dateTo = document.getElementById('paymentsDateTo').value;
    const sortBy = document.getElementById('paymentsSort').value;
    
    let filtered = allPayments.filter(payment => {
        // Text search
        const matchesSearch = !searchTerm || 
            (payment.note || '').toLowerCase().includes(searchTerm) ||
            (payment.method || '').toLowerCase().includes(searchTerm) ||
            (payment.details || '').toLowerCase().includes(searchTerm);
        
        // Date filter
        const paymentDate = new Date(payment.paid_at).toISOString().split('T')[0];
        const matchesDateFrom = !dateFrom || paymentDate >= dateFrom;
        const matchesDateTo = !dateTo || paymentDate <= dateTo;
        
        return matchesSearch && matchesDateFrom && matchesDateTo;
    });
    
    // Sort
    filtered.sort((a, b) => {
        switch (sortBy) {
            case 'date-asc':
                return new Date(a.paid_at) - new Date(b.paid_at);
            case 'date-desc':
                return new Date(b.paid_at) - new Date(a.paid_at);
            case 'amount-asc':
                return (a.amount || 0) - (b.amount || 0);
            case 'amount-desc':
                return (b.amount || 0) - (a.amount || 0);
            default:
                return 0;
        }
    });
    
    renderPayments(filtered);
}

function filterAdjustments() {
    const searchTerm = document.getElementById('adjustmentsSearch').value.toLowerCase();
    const dateFrom = document.getElementById('adjustmentsDateFrom').value;
    const dateTo = document.getElementById('adjustmentsDateTo').value;
    const sortBy = document.getElementById('adjustmentsSort').value;
    
    let filtered = allAdjustments.filter(adjustment => {
        // Text search
        const matchesSearch = !searchTerm || 
            (adjustment.reason || '').toLowerCase().includes(searchTerm) ||
            (adjustment.method || '').toLowerCase().includes(searchTerm) ||
            (adjustment.details || '').toLowerCase().includes(searchTerm);
        
        // Date filter
        const adjustmentDate = new Date(adjustment.created_at).toISOString().split('T')[0];
        const matchesDateFrom = !dateFrom || adjustmentDate >= dateFrom;
        const matchesDateTo = !dateTo || adjustmentDate <= dateTo;
        
        return matchesSearch && matchesDateFrom && matchesDateTo;
    });
    
    // Sort
    filtered.sort((a, b) => {
        switch (sortBy) {
            case 'date-asc':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'date-desc':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'amount-asc':
                return (a.amount || 0) - (b.amount || 0);
            case 'amount-desc':
                return (b.amount || 0) - (a.amount || 0);
            default:
                return 0;
        }
    });
    
    renderAdjustments(filtered);
}

// Main Load Function
async function loadClientDetails() {
    const clientId = getClientIdFromURL();
    
    if (!clientId) {
        document.querySelector('.main-content').innerHTML = `
            <div class="error">
                <h2>Ø®Ø·Ø£</h2>
                <p>Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</p>
                <a href="clients.html" class="btn btn-primary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</a>
            </div>
        `;
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/clients/${clientId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„`);
        }
        
        const data = await response.json();
        clientData = data;
        
        // Store data for filtering
        allDeliveries = data.deliveries || [];
        allPayments = data.payments || [];
        allAdjustments = data.adjustments || [];
        
        // Update page title
        document.getElementById('clientName').textContent = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${data.client.name}`;
        
        // Render all sections
        renderSummary(data.totals || {});
        renderMaterials(data.materialTotals || []);
        renderDeliveries(allDeliveries);
        renderPayments(allPayments);
        renderAdjustments(allAdjustments);
        
    } catch (error) {
        console.error('Error loading client details:', error);
        document.querySelector('.main-content').innerHTML = `
            <div class="error">
                <h2>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
                <p>${error.message}</p>
                <a href="clients.html" class="btn btn-primary">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</a>
            </div>
        `;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('paymentDate').value = today;
    
    // Set default date ranges for reports
    const firstOfYear = new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
    document.getElementById('deliveriesFromDate').value = firstOfYear;
    document.getElementById('deliveriesToDate').value = today;
    
    setupEventHandlers();
    loadClientDetails();
});

// Make functions available globally for onclick handlers
window.closeModal = closeModal;
window.editPayment = editPayment;
window.deletePayment = deletePayment;
window.editAdjustment = editAdjustment;
window.deleteAdjustment = deleteAdjustment;
window.removeImage = function(inputId, previewId) {
    document.getElementById(inputId.replace('Preview', '')).value = '';
    document.getElementById(previewId).innerHTML = '';
};
window.showImageModal = function(imageData) {
    const modalImage = document.getElementById('modalImage');
    
    // Check if imageData is already a valid data URL
    if (imageData && (imageData.startsWith('data:image/') || imageData.startsWith('http'))) {
        modalImage.src = imageData;
    } else if (imageData) {
        // If it's just base64 without the data URL prefix, add it
        modalImage.src = `data:image/png;base64,${imageData}`;
    } else {
        // Fallback for empty or invalid data
        modalImage.src = '';
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§');
        return;
    }
    
    showModal('imageModal');
};

// PDF Report Functions
window.generateDeliveriesReport = async function() {
    const clientId = getClientIdFromURL();
    const fromDate = document.getElementById('deliveriesFromDate').value;
    const toDate = document.getElementById('deliveriesToDate').value;
    
    if (!fromDate || !toDate) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
        return;
    }
    
    try {
        const url = `${API_BASE}/clients/${clientId}/reports/deliveries?from=${fromDate}&to=${toDate}`;
        window.open(url, '_blank');
    } catch (error) {
        console.error('Error generating deliveries report:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
    }
};

window.generateAccountStatement = async function() {
    const clientId = getClientIdFromURL();
    const useCustomRange = document.getElementById('useCustomDateRange').checked;
    
    let fromDate, toDate;
    
    if (useCustomRange) {
        fromDate = document.getElementById('statementFromDate').value;
        toDate = document.getElementById('statementToDate').value;
        
        if (!fromDate || !toDate) {
            alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
            return;
        }
    } else {
        // Use all data - get first and last dates
        fromDate = '';
        toDate = '';
    }
    
    try {
        let url = `${API_BASE}/clients/${clientId}/reports/statement`;
        if (fromDate && toDate) {
            url += `?from=${fromDate}&to=${toDate}`;
        }
        window.open(url, '_blank');
    } catch (error) {
        console.error('Error generating account statement:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨');
    }
};

// Toggle date range inputs
window.toggleDateRange = function() {
    const checkbox = document.getElementById('useCustomDateRange');
    const dateInputs = document.getElementById('dateRangeInputs');
    
    if (checkbox.checked) {
        dateInputs.style.display = 'block';
        // Set default dates
        const today = new Date().toISOString().split('T')[0];
        const firstOfYear = new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
        document.getElementById('statementFromDate').value = firstOfYear;
        document.getElementById('statementToDate').value = today;
    } else {
        dateInputs.style.display = 'none';
    }
};

// Clear filter functions
window.clearDeliveriesFilters = function() {
    document.getElementById('deliveriesSearch').value = '';
    document.getElementById('deliveriesDateFrom').value = '';
    document.getElementById('deliveriesDateTo').value = '';
    document.getElementById('deliveriesSort').value = 'date-desc';
    filterDeliveries();
};

window.clearPaymentsFilters = function() {
    document.getElementById('paymentsSearch').value = '';
    document.getElementById('paymentsDateFrom').value = '';
    document.getElementById('paymentsDateTo').value = '';
    document.getElementById('paymentsSort').value = 'date-desc';
    filterPayments();
};

window.clearAdjustmentsFilters = function() {
    document.getElementById('adjustmentsSearch').value = '';
    document.getElementById('adjustmentsDateFrom').value = '';
    document.getElementById('adjustmentsDateTo').value = '';
    document.getElementById('adjustmentsSort').value = 'date-desc';
    filterAdjustments();
};