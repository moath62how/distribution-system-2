<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>إدخال تسليم جديد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Cairo:400,700,900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="/css/new-entry.css">
    <link rel="stylesheet" href="/css/sidebar.css">
</head>

<body>
    <div id="sidebar-placeholder"></div>
    <div class="main-content">
        <div class="page-header">إدخال تسليم جديد</div>
        <div class="new-entry-form-container">
            <div class="form-header">
                <button type="button" id="refreshBtn" class="refresh-btn">تحديث البيانات</button>
            </div>
            <form id="newEntryForm" autocomplete="off" novalidate>
                <div id="formError" class="form-error"></div>
                <div class="form-group">
                    <label for="client"><span class="required">*</span>العميل</label>
                    <select id="client" required>
                        <option value="">اختر العميل</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="material"><span class="required">*</span>نوع المادة</label>
                    <select id="material" required>
                        <option value="">اختر النوع</option>
                        <option value="رمل">رمل</option>
                        <option value="سن 1">سن 1</option>
                        <option value="سن 2">سن 2</option>
                        <option value="سن 3">سن 3</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="crusher"><span class="required">*</span>الكسارة</label>
                    <select id="crusher" required>
                        <option value="">اختر الكسارة</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="voucher"><span class="required">*</span>رقم البون</label>
                    <input type="text" id="voucher" required maxlength="32" />
                </div>

                <div class="form-group">
                    <label for="wheelContractor"><span class="required">*</span>مقاول النقل</label>
                    <select id="wheelContractor" required>
                        <option value="">اختر المقاول</option>
                    </select>
                </div>

                <div class="form-group flex-row">
                    <div style="flex:1;">
                        <label for="driver"><span class="required">*</span>اسم السائق</label>
                        <input type="text" id="driver" required maxlength="48" />
                    </div>
                    <div style="flex:1;">
                        <label for="carHead"><span class="required">*</span>رقم الرأس</label>
                        <input type="text" id="carHead" required maxlength="28" />
                    </div>
                    <div style="flex:1;">
                        <label for="carTail"><span class="required">*</span>رقم المقطورة</label>
                        <input type="text" id="carTail" required maxlength="28" />
                    </div>
                </div>
                <div style="flex:1;">
                    <label for="carVolume"><span class="required">*</span>تكعيب السيارة (م³)</label>
                    <input type="number" id="carVolume" min="0.01" step="0.01" required />
                </div>

                <div class="form-group">
                    <div class="discount-options">
                        <label class="radio-label">
                            <input type="radio" name="discount" id="discountYes" value="yes" /> خصم
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="discount" id="discountNo" value="no" checked /> بدون خصم
                        </label>
                    </div>
                    <div class="form-group special-deduct" id="deductAmountField" style="display:none;
                        background: linear-gradient(92deg, #e1ecf7 65%, #b6dbef 100%);
                        border: 2.5px dashed #247ae0;
                        border-radius: 10px;
                        padding: 20px 15px 8px 15px;
                        margin: 12px 0 15px 0;
                        box-shadow: 0 4px 12px #247ae020;
                        text-align: right;
                        position: relative;">
                        <label for="deductAmount"
                            style="font-weight:800;font-size:1.11rem;color:#17406b;margin-bottom:11px;display:block;">
                            <span class="required" style="color:#c0392b;font-weight:900;">*</span>
                            قيمة الخصم (م³)
                            <span
                                style="background:#fff8e1;color:#b27b21;padding:2px 8px 2px 8px;border-radius:13px;font-size:0.93em;margin-right:7px;">خاص</span>
                        </label>
                        <input type="number" id="deductAmount" min="0" step="0.01" style="background: #fffde9; border: 1.7px solid #e2be71; border-radius:7px;
                               font-weight:700; color:#bb8300; font-size:1.13em; width: 60%;
                               box-shadow: 0 2px 7px #fffdd430; outline: none; padding:7px 16px;" />
                        <span
                            style="position:absolute;left:13px;top:14px;color:#b6dbef;font-size:1.1rem;font-weight:700;">
                            م³
                        </span>
                    </div>

                    <div class="form-group flex-row">
                        <div style="flex:1;">
                            <label for="quantity"><span class="required">*</span>كمية الحمولة (م³)</label>
                            <input type="number" id="quantity" min="0.01" step="0.01" required />
                        </div>
                        <div style="flex:1;">
                            <label for="price"><span class="required">*</span>السعر لكل م³</label>
                            <input type="number" id="price" min="0" step="0.01" required />
                        </div>
                    </div>



                    <div class="form-group">
                        <label for="contractorCharge">مستحق مشال لكل م³</label>
                        <input type="number" id="contractorCharge" min="0" step="0.01" />
                    </div>

                    <button type="submit" class="save-btn">حفظ البيانات</button>
            </form>
        </div>
    </div>
    <script src="/env.js"></script>
    <script src="/js/sidebar.js"></script>
    <script>
        const API_BASE = (function () {
            if (window.__API_BASE__) return window.__API_BASE__;
            try { const origin = window.location.origin; if (!origin || origin === 'null') return 'http://localhost:5000/api'; return origin.replace(/\/$/, '') + '/api'; } catch (e) { return 'http://localhost:5000/api'; }
        })();

        async function populateSelect(id, data, placeholder) {
            const select = document.getElementById(id);
            select.innerHTML = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = placeholder;
            select.appendChild(defaultOpt);
            if (!data || !Array.isArray(data)) {
                console.error('Invalid data for populateSelect:', data);
                return;
            }
            data.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.textContent = item.name;
                select.appendChild(opt);
            });
        }

        async function loadDropdowns() {
            try {
                const [clients, crushers, contractors] = await Promise.all([
                    fetch(`${API_BASE}/clients`, { cache: 'no-cache' }).then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }),
                    fetch(`${API_BASE}/crushers`, { cache: 'no-cache' }).then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); }),
                    fetch(`${API_BASE}/contractors`, { cache: 'no-cache' }).then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
                ]);

                // Extract arrays from API responses (handle both old and new formats)
                const clientsArray = clients.clients || clients.data || clients;
                const crushersArray = crushers.crushers || crushers.data || crushers;
                const contractorsArray = contractors.contractors || contractors.data || contractors;

                populateSelect('client', clientsArray, 'اختر العميل');
                populateSelect('crusher', crushersArray, 'اختر الكسارة');
                populateSelect('wheelContractor', contractorsArray, 'اختر المقاول');
            } catch (err) {
                console.error(err);
                const errorDiv = document.getElementById('formError');
                errorDiv.textContent = 'تعذر تحميل البيانات الأساسية';
                errorDiv.style.display = 'block';
            }
        }

        // Discount fields toggle
        const discountYes = document.getElementById('discountYes');
        const discountNo = document.getElementById('discountNo');
        const deductAmountField = document.getElementById('deductAmountField');
        discountYes.addEventListener('change', () => {
            if (discountYes.checked) {
                deductAmountField.style.display = '';
                document.getElementById('deductAmount').required = true;
            }
        });
        discountNo.addEventListener('change', () => {
            if (discountNo.checked) {
                deductAmountField.style.display = 'none';
                const d = document.getElementById('deductAmount');
                d.required = false;
                d.value = "";
            }
        });

        // Form submission
        document.getElementById('newEntryForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            let valid = true;
            let err = "";

            const requiredFields = [
                { id: 'client', msg: 'يرجى اختيار العميل' },
                { id: 'material', msg: 'يرجى اختيار نوع المادة' },
                { id: 'crusher', msg: 'يرجى اختيار الكسارة' },
                { id: 'voucher', msg: 'يرجى إدخال رقم البون' },
                { id: 'wheelContractor', msg: 'يرجى اختيار مقاول النقل' },
                { id: 'driver', msg: 'يرجى إدخال اسم السائق' },
                { id: 'carHead', msg: 'يرجى إدخال رقم الرأس' },
                { id: 'carTail', msg: 'يرجى إدخال رقم المقطورة' },
                { id: 'quantity', msg: 'يرجى إدخال كمية الحمولة', type: 'number' },
                { id: 'price', msg: 'يرجى إدخال السعر', type: 'number' },
                { id: 'carVolume', msg: 'يرجى إدخال تكعيب السيارة', type: 'number' }
            ];
            if (discountYes.checked) {
                requiredFields.push({ id: 'deductAmount', msg: 'يرجى تحديد قيمة الخصم', type: 'number' });
            }

            for (const f of requiredFields) {
                const el = document.getElementById(f.id);
                if (!el || !el.value || (el.value.trim && !el.value.trim())) {
                    valid = false;
                    err = f.msg;
                    break;
                }
                if (f.type === 'number' && (isNaN(parseFloat(el.value)) || parseFloat(el.value) <= 0)) {
                    valid = false;
                    err = f.msg;
                    break;
                }
            }

            const errorDiv = document.getElementById('formError');
            if (!valid) {
                errorDiv.textContent = err;
                errorDiv.style.display = "block";
                return false;
            }
            errorDiv.style.display = "none";

            const payload = {
                client_id: document.getElementById('client').value,
                crusher_id: document.getElementById('crusher').value || null,
                contractor_id: document.getElementById('wheelContractor').value || null,
                material: document.getElementById('material').value,
                voucher: document.getElementById('voucher').value,
                quantity: parseFloat(document.getElementById('quantity').value),
                discount_volume: discountYes.checked ? (parseFloat(document.getElementById('deductAmount').value) || 0) : 0,
                price_per_meter: parseFloat(document.getElementById('price').value),
                material_price_at_time: parseFloat(document.getElementById('price').value), // Using client price as fallback - should be crusher price
                driver_name: document.getElementById('driver').value,
                car_head: document.getElementById('carHead').value,
                car_tail: document.getElementById('carTail').value,
                car_volume: parseFloat(document.getElementById('carVolume').value) || null,
                contractor_charge_per_meter: parseFloat(document.getElementById('contractorCharge').value) || 0
            };

            try {
                const resp = await fetch(`${API_BASE}/deliveries`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) {
                    const msg = await resp.text();
                    throw new Error(msg || 'فشل الحفظ');
                }
                await Swal.fire({
                    icon: 'success',
                    title: 'تم الحفظ',
                    text: 'تم حفظ التسليم بنجاح',
                    confirmButtonText: 'حسناً'
                });
                // Reset form but preserve dropdown selections
                const preservedValues = {
                    client: document.getElementById('client').value,
                    crusher: document.getElementById('crusher').value,
                    wheelContractor: document.getElementById('wheelContractor').value
                };
                this.reset();
                // Restore preserved values
                document.getElementById('client').value = preservedValues.client;
                document.getElementById('crusher').value = preservedValues.crusher;
                document.getElementById('wheelContractor').value = preservedValues.wheelContractor;
                deductAmountField.style.display = 'none';
                document.getElementById('deductAmount').required = false;
            } catch (errResp) {
                console.error(errResp);
                errorDiv.textContent = 'تعذر حفظ التسليم';
                errorDiv.style.display = "block";
            }
            return false;
        });

        loadDropdowns();

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadDropdowns();
        });

        // Auto refresh dropdowns every 30 seconds
        setInterval(() => {
            loadDropdowns();
        }, 30000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>

</html>