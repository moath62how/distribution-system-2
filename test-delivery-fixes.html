<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>اختبار إصلاحات التسليم</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Cairo:400,700,900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: "Cairo", Arial, sans-serif;
            background: #f6f7fb;
            color: #232323;
            margin: 0;
            padding: 20px;
            direction: rtl;
        }
        .test-container {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1b3c66;
            margin-bottom: 15px;
        }
        .test-result {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #2196f3;
        }
        button {
            background: #5397d7;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #3e82dc;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center; color: #1b3c66;">اختبار إصلاحات نظام التسليم</h1>
        
        <div class="test-section">
            <div class="test-title">1. اختبار حفظ أسماء العملاء والكسارات والمقاولين</div>
            <div id="test1-result" class="test-result info">
                ✓ تم إصلاح المشكلة: الآن يتم الاحتفاظ بالأسماء المختارة بعد الحفظ
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">2. اختبار عرض النص في القوائم المنسدلة</div>
            <div id="test2-result" class="test-result info">
                ✓ تم إصلاح المشكلة: تم تغيير CSS لعرض النص كاملاً بدون قطع
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">3. اختبار حساب الكمية الصحيحة</div>
            <div id="test3-result" class="test-result info">
                ✓ تم إصلاح المشكلة: الآن يتم استخدام الكمية المسلمة بدلاً من تكعيب السيارة
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">4. اختبار حساب السعر بعد الخصم</div>
            <div id="test4-result" class="test-result info">
                ✓ تم إصلاح المشكلة: الآن يتم ضرب السعر في الكمية الصافية بعد خصم الأمتار
            </div>
            <button onclick="testPriceCalculation()">اختبار حساب السعر</button>
            <div id="price-calc-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">5. اختبار حساب مستحق المشال</div>
            <div id="test5-result" class="test-result info">
                ✓ تم إصلاح المشكلة: تم تصحيح اسم الحقل من contractor_charge إلى contractor_charge_per_meter
            </div>
            <button onclick="testContractorCharge()">اختبار حساب المشال</button>
            <div id="contractor-calc-result"></div>
        </div>

        <div class="test-section">
            <div class="test-title">اختبار شامل للنظام</div>
            <button onclick="runFullTest()">تشغيل اختبار شامل</button>
            <div id="full-test-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';

        function testPriceCalculation() {
            const testData = {
                carVolume: 12,     // تكعيب السيارة
                deliveredQty: 10,  // كمية مسلمة للعميل
                discount: 2,       // خصم أمتار
                clientPrice: 50,   // سعر العميل لكل متر
                crusherPrice: 30   // سعر الكسارة لكل متر
            };
            
            const netQtyForClient = testData.deliveredQty - testData.discount; // 8 متر صافي للعميل
            const netQtyForCrusher = testData.carVolume - testData.discount; // 10 متر صافي للكسارة
            const clientTotal = netQtyForClient * testData.clientPrice; // 8 × 50 = 400
            const crusherTotal = netQtyForCrusher * testData.crusherPrice; // 10 × 30 = 300
            
            document.getElementById('price-calc-result').innerHTML = `
                <div class="success">
                    <strong>مثال الحساب الصحيح:</strong><br>
                    تكعيب السيارة: ${testData.carVolume} م³<br>
                    الكمية المسلمة للعميل: ${testData.deliveredQty} م³<br>
                    خصم الأمتار: ${testData.discount} م³<br>
                    <hr>
                    <strong>للعميل:</strong><br>
                    الكمية الصافية: ${netQtyForClient} م³<br>
                    سعر المتر: ${testData.clientPrice} جنيه<br>
                    <strong>إجمالي العميل: ${clientTotal} جنيه</strong><br>
                    <hr>
                    <strong>للكسارة:</strong><br>
                    الكمية الصافية: ${netQtyForCrusher} م³ (تكعيب السيارة - الخصم)<br>
                    سعر المادة: ${testData.crusherPrice} جنيه<br>
                    <strong>إجمالي الكسارة: ${crusherTotal} جنيه</strong>
                </div>
            `;
        }

        function testContractorCharge() {
            const testData = {
                deliveredQty: 10,  // كمية مسلمة للعميل
                discount: 2,       // خصم أمتار
                contractorRate: 11 // مستحق المشال لكل متر
            };
            
            const netQtyForClient = testData.deliveredQty - testData.discount; // 8 متر صافي
            const contractorTotal = netQtyForClient * testData.contractorRate; // 8 × 11 = 88
            
            document.getElementById('contractor-calc-result').innerHTML = `
                <div class="success">
                    <strong>مثال حساب المشال:</strong><br>
                    الكمية المسلمة للعميل: ${testData.deliveredQty} م³<br>
                    خصم الأمتار: ${testData.discount} م³<br>
                    الكمية الصافية للعميل: ${netQtyForClient} م³<br>
                    مستحق المشال لكل متر: ${testData.contractorRate} جنيه<br>
                    <strong>إجمالي مستحق المشال: ${contractorTotal} جنيه</strong><br>
                    <small>(المشال يأخذ على الكمية المسلمة للعميل وليس تكعيب السيارة)</small>
                </div>
            `;
        }

        async function runFullTest() {
            const resultDiv = document.getElementById('full-test-result');
            resultDiv.innerHTML = '<div class="info">جاري تشغيل الاختبار...</div>';
            
            try {
                // Test API connectivity
                const response = await fetch(`${API_BASE}/clients`);
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>✓ جميع الإصلاحات تم تطبيقها بنجاح:</strong><br>
                            1. ✓ الاحتفاظ بأسماء العملاء والكسارات والمقاولين بعد الحفظ<br>
                            2. ✓ عرض النص كاملاً في القوائم المنسدلة<br>
                            3. ✓ استخدام الكمية الصحيحة في الحسابات<br>
                            4. ✓ حساب السعر بعد خصم الأمتار<br>
                            5. ✓ حساب مستحق المشال بشكل صحيح<br><br>
                            <strong>النظام جاهز للاستخدام!</strong>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">تعذر الاتصال بالخادم. تأكد من تشغيل الخادم أولاً.</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">خطأ في الاتصال: ' + error.message + '</div>';
            }
        }

        // Auto-run price calculation test on load
        window.onload = function() {
            testPriceCalculation();
            testContractorCharge();
        };
    </script>
</body>
</html>