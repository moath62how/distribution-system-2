<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>اختبار إصلاح إغلاق المودال</title>
    <link rel="stylesheet" href="backend/public/css/modern-theme.css">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .btn { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            background: #007bff;
            color: white;
        }
        .btn:hover { background: #0056b3; }
        
        /* Modal styles for testing */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            position: relative;
        }
        
        .modal-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>اختبار إصلاح إغلاق المودال</h1>
    
    <div class="test-section">
        <h2>المشكلة:</h2>
        <p class="error">❌ المودال لا يُغلق عند النقر على أزرار الإغلاق</p>
        <p class="success">✅ تم إضافة event listeners مباشرة لأزرار الإغلاق</p>
        <p class="success">✅ تم إضافة console logging للتتبع</p>
    </div>
    
    <div class="test-section">
        <h2>الإصلاحات المطبقة:</h2>
        <ul>
            <li class="success">✅ إضافة event listeners مباشرة في setupEventHandlers</li>
            <li class="success">✅ إضافة console logging في event delegation</li>
            <li class="success">✅ الاحتفاظ بـ backdrop click للإغلاق</li>
            <li class="info">ℹ️ ثلاث طرق للإغلاق: زر X، زر إلغاء، النقر على الخلفية</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>اختبار المودال:</h2>
        <button class="btn" onclick="testShowModal()">فتح المودال للاختبار</button>
        
        <div id="testModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    تعديل بيانات الاختبار
                    <button class="modal-close" data-action="close-modal" data-target="testModal">&times;</button>
                </div>
                <p>اختبر إغلاق المودال بالطرق التالية:</p>
                <ul>
                    <li>النقر على زر X في الأعلى</li>
                    <li>النقر على زر "إلغاء" في الأسفل</li>
                    <li>النقر على الخلفية الرمادية</li>
                </ul>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-action="close-modal" data-target="testModal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="alert('تم الحفظ!'); testCloseModal()">حفظ</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>الكود المضاف في setupEventHandlers:</h2>
        <pre>
// Direct close button listeners for all modals
document.querySelectorAll('[data-action="close-modal"]').forEach(button => {
    button.addEventListener('click', (e) => {
        const target = e.target.getAttribute('data-target');
        console.log('Direct close button clicked, target:', target);
        if (target) {
            closeModal(target);
        }
    });
});
        </pre>
    </div>
    
    <div class="test-section">
        <h2>Event Delegation المحسن:</h2>
        <pre>
document.addEventListener('click', function(e) {
    const action = e.target.getAttribute('data-action');
    const target = e.target.getAttribute('data-target');
    
    console.log('Click detected on element:', e.target);
    console.log('data-action:', action);
    console.log('data-target:', target);
    
    if (action === 'close-modal' && target) {
        console.log('Closing modal:', target);
        closeModal(target);
    }
});
        </pre>
    </div>
    
    <div class="test-section">
        <h2>للاختبار في الصفحات الحقيقية:</h2>
        <ol>
            <li>افتح <a href="backend/public/contractor-details.html?id=1" target="_blank">صفحة تفاصيل المقاول</a></li>
            <li>اضغط على زر "✏️ تعديل البيانات"</li>
            <li>يجب أن يظهر المودال</li>
            <li>جرب إغلاق المودال بالطرق التالية:</li>
            <ul>
                <li>النقر على زر X</li>
                <li>النقر على زر "إلغاء"</li>
                <li>النقر على الخلفية</li>
            </ul>
            <li>تحقق من console للرسائل التالية:</li>
            <ul>
                <li>"Direct close button clicked, target: editContractorModal"</li>
                <li>"closeModal called with: editContractorModal"</li>
                <li>"Modal closed"</li>
            </ul>
        </ol>
    </div>

    <script>
        // Simulate the same functions as in the real files
        function showModal(modalId) {
            console.log('showModal called with:', modalId);
            const modal = document.getElementById(modalId);
            console.log('Modal element found:', !!modal);
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
                console.log('Modal should now be visible');
            } else {
                console.error('Modal not found:', modalId);
            }
        }
        
        function closeModal(modalId) {
            console.log('closeModal called with:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
                console.log('Modal closed');
            }
        }
        
        function testShowModal() {
            showModal('testModal');
        }
        
        function testCloseModal() {
            closeModal('testModal');
        }
        
        // Simulate the direct event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Direct close button listeners for all modals
            document.querySelectorAll('[data-action="close-modal"]').forEach(button => {
                button.addEventListener('click', (e) => {
                    const target = e.target.getAttribute('data-target');
                    console.log('Direct close button clicked, target:', target);
                    if (target) {
                        closeModal(target);
                    }
                });
            });
            
            // Modal close on backdrop click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        console.log('Backdrop clicked, closing modal:', modal.id);
                        closeModal(modal.id);
                    }
                });
            });
        });
        
        // Event delegation (backup)
        document.addEventListener('click', function(e) {
            const action = e.target.getAttribute('data-action');
            const target = e.target.getAttribute('data-target');
            
            console.log('Click detected on element:', e.target);
            console.log('data-action:', action);
            console.log('data-target:', target);
            
            if (action === 'close-modal' && target) {
                console.log('Closing modal via event delegation:', target);
                closeModal(target);
            }
        });
    </script>
</body>
</html>